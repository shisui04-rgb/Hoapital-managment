from datetime import datetime
import os
from openpyxl import Workbook, load_workbook

DATA_FILE = os.path.join("data", "patients.xlsx")

def main():
    print("Welcome to the Patient Management System")
    
    # Input patient details
    name = input("Enter patient's name: ")
    dob = get_valid_date("Enter patient's date of birth (YYYY-MM-DD): ")
    mobile_no = get_valid_mobile("Enter patient's mobile number: ")
    batch_no = get_valid_batch("Enter patient's batch number: ")

    # Save data after validation
    save_patient_data(name, dob, mobile_no, batch_no)

# Ensure the data directory exists
if not os.path.exists('data'):
    os.makedirs('data')

# -------- Validation Helpers --------
def get_valid_date(prompt):
    while True:
        dob = input(prompt)
        if validate_date(dob):
            return dob
        print("‚ùå Invalid date format. Please enter in YYYY-MM-DD format.")

def get_valid_mobile(prompt):
    while True:
        mobile = input(prompt)
        if validate_mobile_number(mobile):
            return mobile
        print("‚ùå Invalid mobile number. Enter a valid 10-digit Indian number (starts with 6‚Äì9).")

def get_valid_batch(prompt):
    while True:
        batch = input(prompt)
        if validate_batch_number(batch):
            return batch
        print("‚ùå Invalid batch number. Enter numeric value only.")

def validate_date(date_str):
    """Validate the date format (YYYY-MM-DD)"""
    try:
        datetime.strptime(date_str, "%Y-%m-%d")
        return True
    except ValueError:
        return False

def validate_mobile_number(mobile_str):
    """Validate Indian mobile number (10 digits, starts with 6‚Äì9)."""
    return mobile_str.isdigit() and len(mobile_str) == 10 and mobile_str[0] in "6789"

def validate_batch_number(batch_str):
    """Validate that the batch number is numeric"""
    return batch_str.isdigit()

# -------- Excel Saving --------
def save_patient_data(name, dob, mobile_no, batch_no):
    """Save patient data to an Excel file."""
    
    # If file doesn‚Äôt exist, create with headers
    if not os.path.exists(DATA_FILE):
        wb = Workbook()
        ws = wb.active
        ws.title = "Patients"
        ws.append(["Name", "Date of Birth", "Mobile Number", "Batch Number"])
        wb.save(DATA_FILE)

    # Append new row
    wb = load_workbook(DATA_FILE)
    ws = wb.active
    ws.append([name, dob, mobile_no, batch_no])
    wb.save(DATA_FILE)

    # Print full path
    abs_path = os.path.abspath(DATA_FILE)
    print(f"‚úÖ Patient data saved successfully in Excel.\nüìÇ File location: {abs_path}")

if __name__ == "__main__":
    main()
